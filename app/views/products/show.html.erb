<div class="container mt-5">
  <div class="row">
    <div class="col-md-6">
      <% if @product.main_photo.attached? %>
        <%= image_tag @product.main_photo, class: "img-fluid rounded", alt: @product.name %>
      <% else %>
        <p class="text-muted">No photo available</p>
      <% end %>
    </div>

    <div class="col-md-6">
      <h1 class="text-primary"><%= @product.name %></h1>
      <p><strong>Category:</strong> <%= @product.product_category.name %></p>
      <p><strong>Tags:</strong> <%= @product.tags.map(&:name).join(", ") %></p>
      <p><strong>SKU:</strong> <%= @product.sku %></p>
      <p><strong>Description:</strong> <%= @product.description.presence || "No description available" %></p>
      <p><strong>Price:</strong> 
        <span id="product-price" data-base-price="<%= @product.price %>">
          <% if @variations.any? && @min_price != @max_price %>
            <%= number_to_currency(@min_price) %> - <%= number_to_currency(@max_price) %>
          <% else %>
            <%= number_to_currency(@min_price) %>
          <% end %>
        </span>
      </p>

      <% if @variations.any? %>
      <div class="mt-4">
        <h4>Available Variations</h4>
        <form id="add-to-cart-form" action="<%= add_item_cart_path %>" method="post">
          <%= hidden_field_tag :product_id, @product.id %>
          <% @variations.group_by { |v| v.variation.name }.each do |variation_type, product_variations| %>
            <div class="mb-3">
              <label class="form-label"><%= variation_type %></label>
              <select class="form-select variation-select" name="product_variation_id">
                <option value="">Select <%= variation_type %></option>
                <% product_variations.each do |product_variation| %>
                  <% product_variation.product_variation_values.each do |value| %>
                    <option value="<%= product_variation.id %>" data-price="<%= product_variation.price %>">
                      <%= value.variation_value.name %> - <%= product_variation.price %>
                    </option>
                  <% end %>
                <% end %>
              </select>
            </div>
          <% end %>
          <button id="add-to-cart-btn" class="btn btn-primary" type="submit" disabled>Add to Cart</button>
        </form>
      </div>
      <% else %>
      <!-- When there are no variations, render the Add to Cart button enabled -->
      <div class="mt-4">
        <%= form_with url: add_item_cart_path, method: :post, local: true do |f| %>
          <%= f.hidden_field :product_id, value: @product.id %>
          <button id="add-to-cart-btn" class="btn btn-primary" type="submit">Add to Cart</button>
        <% end %>
      </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const dropdowns = document.querySelectorAll(".variation-select");
  const addToCartButton = document.getElementById("add-to-cart-btn");

  function updateButtonState() {
    let allSelected = true;
    dropdowns.forEach(dropdown => {
      if (!dropdown.value) {
        allSelected = false;
      }
    });

    if (allSelected) {
      addToCartButton.removeAttribute("disabled"); // Enable the button
    } else {
      addToCartButton.setAttribute("disabled", true); // Disable the button
    }
  }

  dropdowns.forEach(dropdown => {
    dropdown.addEventListener("change", updateButtonState);
  });
});
</script>
